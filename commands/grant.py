from telegram import (
    Update,
    InlineKeyboardMarkup,
    InlineKeyboardButton
)

from telegram.ext import (
    CallbackContext,
    ConversationHandler
)

from classes.pyson import Pyson
from classes.command import Command

from classes.bot import (
    signal_last,
    send_message,
    delete_messages
)

from config import ADMINS_FILE
from commands.back import BACK_COMMAND


def grant(
    update: Update,
    context: CallbackContext
) -> str:
    message = update.message
    blank = True

    if message and not Command.filter(message):
        mentions = list(message.parse_entities("mention").values())
        delete_messages(update, context)

        if mentions:
            admins = Pyson.read(ADMINS_FILE)
            markup = None

            for last, mention in signal_last(mentions):
                username = str(mention)[1:]
                admin = {"username": username}

                if admin in admins:
                    state = "warning"
                else:
                    Pyson.append(ADMINS_FILE, admin)
                    state = "success"

                if last:
                    markup = GRANT_COMMAND.markup

                response = GRANT_COMMAND.states[state].format(username)
                send_message(update, context, response, markup, blank=False)

            return ConversationHandler.END
        else:
            blank = False
            send_message(update, context, GRANT_COMMAND.states["error"])

    send_message(
        update, context,
        GRANT_COMMAND.states["default"],
        GRANT_COMMAND.markup, blank=blank
    )

    return GRANT_COMMAND.name


GRANT_COMMAND = Command(
    callback=grant,
    description="‚ûï –ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞",

    states={
        "default": "üë®üèª‚Äçüíª –í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º: ",
        "success": "‚úÖ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{} —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!</b>",
        "warning": "‚ö†Ô∏è <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{} —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!</b>",
        "error": "‚ùå <b>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –≤–≤–µ–¥–µ–Ω–æ –Ω–µ–≤–µ—Ä–Ω–æ!</b>"
    },

    markup=InlineKeyboardMarkup([
        [InlineKeyboardButton(
            text=BACK_COMMAND.description,
            callback_data=BACK_COMMAND.name
        )]
    ])
)
